<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>考试进行中</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend id="remainingTime">考试倒计时：</legend>
</fieldset>

<script src="layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
    layui.use(['form'], function () {
        var form = layui.form
            , layer = layui.layer;

        var intervalIndex = 0;

        layui.$.ajax({
            url: 'examSession/selectPaper.do' + location.search,
            success: function (result) {
                if (result.code === 0) {
                    //动态生成倒计时
                    //获取考试时长(min)
                    var remainingTime = result.data.remainingTime;

                    var $remainingTime = layui.$('#remainingTime');

                    var second = remainingTime % 60;
                    var minute = parseInt(remainingTime / 60) % 60;
                    var hour = parseInt(parseInt(remainingTime / 60) / 60);


                    if (hour < 10) {
                        hour = '0' + hour;
                    } else {
                        hour = '' + hour;
                    }
                    if (minute < 10) {
                        minute = '0' + minute;
                    } else {
                        minute = '' + minute;
                    }
                    if (second < 10) {
                        second = '0' + second;
                    } else {
                        second = '' + second;
                    }

                    $remainingTime.html('考试倒计时:' + hour + ':' + minute + ':' + second);

                    intervalIndex = setInterval(function () {
                        var times = $remainingTime.html().split(':');
                        hour = parseInt(times[1]);
                        minute = parseInt(times[2]);
                        second = parseInt(times[3]);

                        if (second <= 0) {
                            if (minute <= 0) {
                                if (hour <= 0) {
                                    //自动交卷
                                    layui.$('form:visible button:last').click();
                                } else {
                                    hour -= 1;
                                    minute = 59;
                                    second = 59;
                                }
                            } else {
                                minute -= 1;
                                second = 59;
                            }
                        } else {
                            second -= 1;
                        }

                        if (hour < 10) {
                            hour = '0' + hour;
                        } else {
                            hour = '' + hour;
                        }
                        if (minute < 10) {
                            minute = '0' + minute;
                        } else {
                            minute = '' + minute;
                        }
                        if (second < 10) {
                            second = '0' + second;
                        } else {
                            second = '' + second;
                        }

                        $remainingTime.html('考试倒计时:' + hour + ':' + minute + ':' + second);

                        if (hour == 0 && minute == 0 && second == 30) {
                            layer.alert('距离考试结束还有30秒', {title: '温馨提示'});
                        }
                    }, 1000);

                    //动态生成试题form表单
                    //从地址栏拆出考试场次id和学生id
                    var urlParams = location.search;
                    urlParams = urlParams.replace('?', '');
                    urlParams = urlParams.split('&');
                    var examSessionId = urlParams[0];
                    examSessionId = examSessionId.substring(examSessionId.indexOf('=') + 1);
                    var studentId = urlParams[1];
                    studentId = studentId.substring(studentId.indexOf('=') + 1);

                    //获取题目信息
                    var papersList = result.data.papersList;
                    for (var i in papersList) {
                        var questions = papersList[i].questions;
                        var questionsTypeId = questions.questionsTypeId;
                        var questionsInfo = questions.questionsInfo.replace('<', '&lt;');
                        var studentAnswer = papersList[i].studentAnswer;
                        if (studentAnswer == null) {
                            studentAnswer = '';
                        }

                        var tags = '';
                        //只有第一道题默认显示
                        if (i == 0) {
                            tags += '<form class="layui-form" action="">\n';
                        } else {
                            tags += '<form class="layui-form" action="" hidden>\n';
                        }
                        //根据题型添加标签
                        switch (questionsTypeId) {
                            case 0:
                                //单选题
                                //拆分题干为题干和选项
                                questionsInfo = questionsInfo.split('%-');
                                tags +=
                                    '    <fieldset class="layui-elem-field">\n' +
                                    '        <legend>单选题</legend>\n' +
                                    '        <div class="layui-field-box">\n' +
                                    '            <blockquote class="layui-elem-quote layui-quote-nm">' + questionsInfo[0] + '</blockquote>\n' +
                                    '            <input type="hidden" name="examSessionId" autocomplete="off" class="layui-input" value="' + examSessionId + '">\n' +
                                    '            <input type="hidden" name="studentId" autocomplete="off" class="layui-input" value="' + studentId + '">\n' +
                                    '            <input type="hidden" name="papersIndex" autocomplete="off" class="layui-input" value="' + i + '">\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <label class="layui-form-label">选项</label>\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="A" title="' + questionsInfo[1] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="B" title="' + questionsInfo[2] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="C" title="' + questionsInfo[3] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="D" title="' + questionsInfo[4] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '        </div>\n' +
                                    '    </fieldset>';

                                //回显考生答案
                                switch (studentAnswer) {
                                    case 'B':
                                        tags = tags.replace('<input type="radio" name="answer" value="B" title="' + questionsInfo[2] + '">', '<input type="radio" name="answer" value="B" title="' + questionsInfo[2] + '" checked>');
                                        break;
                                    case 'C':
                                        tags = tags.replace('<input type="radio" name="answer" value="C" title="' + questionsInfo[3] + '">', '<input type="radio" name="answer" value="C" title="' + questionsInfo[3] + '" checked>');
                                        break;
                                    case 'D':
                                        tags = tags.replace('<input type="radio" name="answer" value="D" title="' + questionsInfo[4] + '">', '<input type="radio" name="answer" value="D" title="' + questionsInfo[4] + '" checked>');
                                        break;
                                    default:
                                        tags = tags.replace('<input type="radio" name="answer" value="A" title="' + questionsInfo[1] + '">', '<input type="radio" name="answer" value="A" title="' + questionsInfo[1] + '" checked>');
                                        break;
                                }
                                break;
                            case 1:
                                //多选题
                                //拆分题干为题干和选项
                                questionsInfo = questionsInfo.split('%-');
                                tags +=
                                    '    <fieldset class="layui-elem-field">\n' +
                                    '        <legend>多选题</legend>\n' +
                                    '        <div class="layui-field-box">\n' +
                                    '            <blockquote class="layui-elem-quote layui-quote-nm">' + questionsInfo[0] + '</blockquote>\n' +
                                    '            <input type="hidden" name="examSessionId" autocomplete="off" class="layui-input" value="' + examSessionId + '">\n' +
                                    '            <input type="hidden" name="studentId" autocomplete="off" class="layui-input" value="' + studentId + '">\n' +
                                    '            <input type="hidden" name="papersIndex" autocomplete="off" class="layui-input" value="' + i + '">\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <label class="layui-form-label">选项</label>\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="checkbox" name="answerA" value="A" lay-skin="primary" title="' + questionsInfo[1] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="checkbox" name="answerB" value="B" lay-skin="primary" title="' + questionsInfo[2] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="checkbox" name="answerC" value="C" lay-skin="primary" title="' + questionsInfo[3] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="checkbox" name="answerD" value="D" lay-skin="primary" title="' + questionsInfo[4] + '">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '        </div>\n' +
                                    '    </fieldset>';

                                //回显考生答案
                                studentAnswer = studentAnswer.split('');
                                for (var studentAnswerTemp of studentAnswer) {
                                    switch (studentAnswerTemp) {
                                        case 'A':
                                            tags = tags.replace('<input type="checkbox" name="answerA" value="A" lay-skin="primary" title="' + questionsInfo[1] + '">', '<input type="checkbox" name="answerA" value="A" lay-skin="primary" title="' + questionsInfo[1] + '" checked>');
                                            break;
                                        case 'B':
                                            tags = tags.replace('<input type="checkbox" name="answerB" value="B" lay-skin="primary" title="' + questionsInfo[2] + '">', '<input type="checkbox" name="answerB" value="B" lay-skin="primary" title="' + questionsInfo[2] + '" checked>');
                                            break;
                                        case 'C':
                                            tags = tags.replace('<input type="checkbox" name="answerC" value="C" lay-skin="primary" title="' + questionsInfo[3] + '">', '<input type="checkbox" name="answerC" value="C" lay-skin="primary" title="' + questionsInfo[3] + '" checked>');
                                            break;
                                        case 'D':
                                            tags = tags.replace('<input type="checkbox" name="answerD" value="D" lay-skin="primary" title="' + questionsInfo[4] + '">', '<input type="checkbox" name="answerD" value="D" lay-skin="primary" title="' + questionsInfo[4] + '" checked>');
                                            break;
                                    }
                                }
                                break;
                            case 2:
                                //判断题
                                tags +=
                                    '    <fieldset class="layui-elem-field">\n' +
                                    '        <legend>判断题</legend>\n' +
                                    '        <div class="layui-field-box">\n' +
                                    '            <blockquote class="layui-elem-quote layui-quote-nm">' + questionsInfo + '</blockquote>\n' +
                                    '            <input type="hidden" name="examSessionId" autocomplete="off" class="layui-input" value="' + examSessionId + '">\n' +
                                    '            <input type="hidden" name="studentId" autocomplete="off" class="layui-input" value="' + studentId + '">\n' +
                                    '            <input type="hidden" name="papersIndex" autocomplete="off" class="layui-input" value="' + i + '">\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <label class="layui-form-label">选项</label>\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="true" title="正确">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '            <div class="layui-form-item">\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <input type="radio" name="answer" value="false" title="错误">\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '        </div>\n' +
                                    '    </fieldset>';

                                //回显考生答案
                                switch (studentAnswer) {
                                    case 'false':
                                        tags = tags.replace('<input type="radio" name="answer" value="false" title="错误">', '<input type="radio" name="answer" value="false" title="错误" checked>');
                                        break;
                                    default:
                                        tags = tags.replace('<input type="radio" name="answer" value="true" title="正确">', '<input type="radio" name="answer" value="true" title="正确" checked>');
                                        break;
                                }
                                break;
                            case 3:
                                //简答题
                                tags +=
                                    '    <fieldset class="layui-elem-field">\n' +
                                    '        <legend>简答题</legend>\n' +
                                    '        <div class="layui-field-box">\n' +
                                    '            <blockquote class="layui-elem-quote layui-quote-nm">' + questionsInfo + '</blockquote>\n' +
                                    '            <input type="hidden" name="examSessionId" autocomplete="off" class="layui-input" value="' + examSessionId + '">\n' +
                                    '            <input type="hidden" name="studentId" autocomplete="off" class="layui-input" value="' + studentId + '">\n' +
                                    '            <input type="hidden" name="papersIndex" autocomplete="off" class="layui-input" value="' + i + '">\n' +
                                    '            <div class="layui-form-item layui-form-text">\n' +
                                    '                <label class="layui-form-label">作答区</label>\n' +
                                    '                <div class="layui-input-block">\n' +
                                    '                    <textarea name="answer" placeholder="请输入内容" class="layui-textarea">' + studentAnswer + '</textarea>\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '        </div>\n' +
                                    '    </fieldset>';
                                break;
                        }

                        if (i == 0) {
                            //第一题没有上一题
                            tags +=
                                '    <div class="layui-form-item">\n' +
                                '        <div class="layui-input-block">\n' +
                                '            <button type="submit" class="layui-btn" lay-submit lay-filter="next">下一题</button>\n' +
                                '            <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="submit">交卷</button>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</form>'
                        } else if (i == papersList.length - 1) {
                            //最后一题没有下一题
                            tags +=
                                '    <div class="layui-form-item">\n' +
                                '        <div class="layui-input-block">\n' +
                                '            <button type="submit" class="layui-btn" lay-submit lay-filter="prev">上一题</button>\n' +
                                '            <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="submit">交卷</button>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</form>';
                        } else {
                            tags +=
                                '<div class="layui-form-item">\n' +
                                '        <div class="layui-input-block">\n' +
                                '            <button type="submit" class="layui-btn" lay-submit lay-filter="prev">上一题</button>\n' +
                                '            <button type="submit" class="layui-btn" lay-submit lay-filter="next">下一题</button>\n' +
                                '            <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="submit">交卷</button>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</form>';
                        }

                        layui.$('body').append(tags);
                    }
                    form.render();
                } else {
                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                    layer.msg("试卷生成失败", {time: 1000}, function () {
                        parent.layer.close(index); //再执行关闭
                    });
                }
            }
        });

        //监听上一题按钮提交
        form.on('submit(prev)', function (data) {
            layui.$.ajax({
                url: 'examSession/cachePaper.do',
                type: 'post',
                data: data.field,
                success: function (result) {
                    if (result.code === 0) {
                        //切题目
                        var $form = layui.$(data.form);
                        var $prevForm = $form.prev('form');
                        $form.attr('hidden', true);
                        $prevForm.attr('hidden', false);
                    } else {
                        layer.msg('操作失败', {time: 1000});
                    }
                }
            });
            return false;
        });
        //监听下一题按钮提交
        form.on('submit(next)', function (data) {
            layui.$.ajax({
                url: 'examSession/cachePaper.do',
                type: 'post',
                data: data.field,
                success: function (result) {
                    if (result.code === 0) {
                        //切题目
                        var $form = layui.$(data.form);
                        var $nextForm = $form.next('form');
                        $form.attr('hidden', true);
                        $nextForm.attr('hidden', false);
                    } else {
                        layer.msg('操作失败', {time: 1000});
                    }
                }
            });
            return false;
        });
        //监听交卷按钮提交
        form.on('submit(submit)', function (data) {
            var times = layui.$('#remainingTime').html().split(':');
            var hour = parseInt(times[1]);
            var minute = parseInt(times[2]);
            var second = parseInt(times[3]);

            if (hour <= 0 && minute <= 0 && second <= 0) {
                //倒计时为0说明是自动交卷
                clearInterval(intervalIndex);
                layer.alert('考试结束，自动交卷', {title: '温馨提示'});
                var $form = layui.$(data.form);
                $form.attr('hidden', true);
                layui.$.ajax({
                    url: 'examSession/submitPaper.do',
                    type: 'post',
                    data: data.field,
                    success: function (result) {
                        if (result.code === 0) {
                            close();
                        } else {
                            layer.msg('操作失败', {time: 1000});
                        }
                    }
                });
            } else {
                //手动交卷
                layer.confirm('确定要交卷？', {
                    btn: ['确定', '取消']
                }, function (index) {
                    layui.$.ajax({
                        url: 'examSession/submitPaper.do',
                        type: 'post',
                        data: data.field,
                        success: function (result) {
                            if (result.code === 0) {
                                layer.close(index);
                                var $form = layui.$(data.form);
                                $form.attr('hidden', true);
                                clearInterval(intervalIndex);
                                close();
                            } else {
                                layer.msg('操作失败', {time: 1000});
                            }
                        }
                    });
                });
            }

            return false;
        });
    });
</script>

</body>
</html>